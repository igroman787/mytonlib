#!/usr/bin/env python3
# -*- coding: utf_8 -*-

import math
import json
import fastcrc
from io import BytesIO as ByteStream
from bitstring import BitArray, BitStream # pip3 install bitstring
from mytypes import Cell, Slice, Dict, int_be, cell2dict

def deserialize_boc(data):
	#print(f"deserialize_boc data: {data.hex()}")
	byte_stream = ByteStream(data)
	magic = bytes.fromhex("b5ee9c72")
	if byte_stream.read(4) != magic:
		raise Exception("deserialize_boc error: invalid boc magic header")
	flags_byte = byte_stream.read(1)
	data_size = int_be(byte_stream.read(1))
	flags, ref_sz_bytes = parse_flags(flags_byte)
	
	cells_num = int_be(byte_stream.read(ref_sz_bytes))
	roots_num = int_be(byte_stream.read(ref_sz_bytes))
	absent_bytes = byte_stream.read(ref_sz_bytes)
	data_len_bytes = byte_stream.read(data_size)
	data_len = int_be(data_len_bytes)
	
	root_list = byte_stream.read(roots_num * ref_sz_bytes)
	root_index = int_be(root_list[0:ref_sz_bytes])
	
	index = list()
	if flags.has_index:
		idx_data = byte_stream.read(cells_num * data_size)
		n = 0
		for i in range(cells_num):
			off = i * data_size
			val = int_be(idx_data[off : off+data_size])
			if flags.has_cache_bits:
				# TODO: check caches
				if val%2 == 1:
					n += 1
				val /= 2
			index.append(val)
		#end for
	#end if
	
	data = byte_stream.read(data_len)
	index = None
	offset = 0
	cells = dict()
	referred = dict()
	for i in range(cells_num):
		cells[i] = Cell()
		referred[i] = False
	#end for
	
	for i in range(cells_num):
		if index != None:
			offset = 0
			if i > 0:
				offset = index[i-1]
		#end if
		
		flags = data[offset]
		refs_num = (flags & 0b111)
		special = (flags & 0b1000) != 0
		with_hashes = (flags & 0b10000) != 0
		level_mask = flags >> 5
		
		if refs_num > 4:
			raise Exception("DeserializeCells error: too many refs in cell")
		#end if
		
		ln = data[offset+1]
		one_more = ln % 2
		sz = int(ln/2 + one_more)
		
		offset += 2
		if len(data)-offset < sz:
			raise Exception("DeserializeCells error: failed to parse cell payload, corrupted data")
		#end if
		
		if with_hashes is True:
			mask_bits = int(math.ceil(math.log2(level_mask + 1)))
			hashes_num = mask_bits + 1
			
			hash_size = 32
			depth_size = 2
			offset += hashes_num*hash_size + hashes_num*depth_size
			# TODO: check depth and hashes
		#end if
		
		payload = data[offset:offset+sz]
		offset += sz
		
		if len(data)-offset < refs_num*ref_sz_bytes :
			raise Exception("DeserializeCells error: failed to parse cell refs, corrupted data")
		#end if
		
		refs_index = dict()
		for y in range(refs_num):
			ref_index = data[offset:offset+ref_sz_bytes]
			refs_index[y] = int_be(ref_index)
			offset += ref_sz_bytes
		#end for
		
		refs = dict()
		for y, id in refs_index.items():
			if i == id:
				raise Exception("DeserializeCells error: recursive reference of cells")
			if id < i and index == None:
				raise Exception("DeserializeCells error: reference to index which is behind parent cell")
			if id >= cells_num:
				raise Exception("DeserializeCells error: invalid index, out of scope")
			refs[y] = cells[id]
			referred[id] = True
		#end for
		
		refs_new = list()
		for key, value in refs.items():
			refs_new.append(value)
		refs = refs_new
		
		# if not full byte
		bits_sz = ln * 4
		if ln%2 != 0:
			for y in range(8):
				if (payload[len(payload)-1]>>y)&1 == 1:
					bits_sz += 3 - y
					break
		#end if
		
		cells[i].special = special
		cells[i].bits_sz = bits_sz
		cells[i].level = level_mask
		cells[i].data = payload
		cells[i].refs = refs
	#end for
	
	roots = list()
	for y, is_ref in referred.items():
		if is_ref is False:
			roots.append(cells[y])
	#end for
	
	if len(roots) != roots_num:
		raise Exception("DeserializeCells error: roots num not match actual num")
	#end if
    
	if len(roots) == 1:
		result = roots[0]
	else:
		result = roots
	return result
#end define

def parse_flags(byte):
	a = byte[0] # convert byte to int
	flags = Dict()
	flags["has_index"] = a & (1<<7) > 0
	flags["has_crc32c"] = a & (1<<6) > 0
	flags["has_cache_bits"] = a & (1<<5) > 0
	flags.to_class()
	ref_sz_bytes  = a & 0b00000111
	return flags, ref_sz_bytes
#end define

def serialize_boc(cell, with_crc=False):
	"""
	serialized_boc#b5ee9c72 has_idx:(## 1) has_crc32c:(## 1) 
	  has_cache_bits:(## 1) flags:(## 2) { flags = 0 }
	  size:(## 3) { size <= 4 }
	  off_bytes:(## 8) { off_bytes <= 8 } 
	  cells:(##(size * 8)) 
	  roots:(##(size * 8)) { roots >= 1 }
	  absent:(##(size * 8)) { roots + absent <= cells }
	  tot_cells_size:(##(off_bytes * 8))
	  root_list:(roots * ##(size * 8))
	  index:has_idx?(cells * ##(off_bytes * 8))
	  cell_data:(tot_cells_size * [ uint8 ])
	  crc32c:has_crc32c?uint32
	  = BagOfCells;
	"""
	# recursively go through cells, build hash index and store unique in slice
	magic = bytes.fromhex("b5ee9c72")
	order_cells = smooth(cell)
	index(order_cells)
	cells_num = len(order_cells)
	
	# bytes needed to store num of cells
	cell_size_bits = math.log2(cells_num + 1)
	cell_size = math.ceil(cell_size_bits / 8)
	cell_size_bytes = int.to_bytes(cell_size, length=1, byteorder="little", signed=False)
	
	payload = bytes()
	for item in order_cells:
		payload += serialize_cell(item, cell_size)
	#end for
	
	# bytes needed to store len of payload
	size_bits = math.log2(len(payload) + 1)
	size = math.ceil(size_bits / 8)
	size_bytes = int.to_bytes(size, length=1, byteorder="little", signed=False)
	
	flags = 0b00000000
	if with_crc:
		flags |= 0b01000000
	flags |= cell_size
	flags_bytes = int.to_bytes(flags, length=1, byteorder="little", signed=False)
	
	result = bytes()
	result += magic
	result += flags_bytes
	result += size_bytes
	
	# cells num
	cells_num_bytes = dynamic_int_bytes(cells_num, cell_size)
	result += cells_num_bytes

	# roots num (only 1 supported for now)
	roots_num_bytes = dynamic_int_bytes(1, cell_size)
	result += roots_num_bytes

	# absent (only 0 supported for now)
	absent_bytes = dynamic_int_bytes(0, cell_size)
	result += absent_bytes

	# len of data
	tot_cells_size = len(payload)
	tot_cells_size_bytes = dynamic_int_bytes(tot_cells_size, size)
	result += tot_cells_size_bytes

	# root should have index 0
	result += dynamic_int_bytes(0, cell_size)
	result += payload
	
	if with_crc:
		buff = fastcrc.crc32.iso_hdlc(text.encode("utf8"))
		checksum = int.to_bytes(buff, length=4, byteorder="little")
		result += checksum
	#end if
	
	return result
#end define

def smooth(cell, result=None):
	if result is None:
		result = list()
	if cell in result:
		result.remove(cell)
	result.append(cell)
	for ref in cell.refs:
		smooth(ref, result)
	return result
#end define

def index(order_cells):
	for i in range(len(order_cells)):
		item = order_cells[i]
		item.index = i
#end define

def serialize_cell(cell, cell_size_bytes, is_hash=False):
	payload = cell.data
	
	unused_bits = 8 - (cell.bits_sz % 8)
	if unused_bits != 8:
		payload[len(payload)-1] += 1 << (unused_bits - 1)
	#end if
	
	result = descriptors(cell) + payload
	
	if is_hash:
		#for ref in cell.refs:
		#	data = append(data, make([]byte, 2)...)
		#	binary.BigEndian.PutUint16(data[len(data)-2:], uint16(ref.maxDepth(0)))
		#}
		#for ref in cell.refs:
		#	data = append(data, ref.Hash()...)
		#}
		pass
	else:
		for ref in cell.refs:
			result += dynamic_int_bytes(ref.index, cell_size_bytes)
	#end if
	
	return result
#end define

def descriptors(cell):
	ceil_bytes_num = int(cell.bits_sz / 8)
	if cell.bits_sz % 8 != 0:
		ceil_bytes_num += 1
	#end if
	
	spec_bit = 0
	if cell.special:
		spec_bit = 8
	#end if
	
	d1 = len(cell.refs) + spec_bit + cell.level*32
	d2 = int(ceil_bytes_num + cell.bits_sz/8)
	d1_bytes = int.to_bytes(d1, length=1, byteorder="big", signed=False)
	d2_bytes = int.to_bytes(d2, length=1, byteorder="big", signed=False)
	result = d1_bytes + d2_bytes
	return result
#end define

def dynamic_int_bytes(value, size):
	data = int.to_bytes(value, length=8, byteorder="big", signed=False)
	data_length = 8 - size
	result = data[data_length:]
	return result
#end define

def tests():
	data = bytes.fromhex("b5ee9c72e202014a000100002a6b0000002400cc00ea0180026202fe033003520361037a0394048c04fc051605be05fe06f0076007ac0854089408fe094b09960a620a820b180b360b540b720b900bae0bcc0bea0c080c260c440cf20d160d3a0de60e060e260e460e640e820e9e0eba0ed60ef20f0e0fb41038105c107c10c81114113411541174119211b211d211f212121232125212fc138413e613f81476149414b214d014ec15901610161e162c163a16481656166416721680168e169c16aa16f6170417121720172e173c174a175817661774178217ce17dc17ea17f81806181418221830187c18a018c4191119bc19dc19fc1a491a951ab41ad21b1f1b6b1b881ba41bf11c3d1c581c741cc11d0d1d281d751d901e361e831f061f531fa51ff02010205d20a920c820e821352154217221bf21de222b224a226a22b722d62323236f238e23db23fa24a424f1257825c526262673268426d1274e279b27b828052822286f288c28d92925294029e42a312ab02afd2b492b952be12cac2cf92d182d262d732d902ddd2dfa2e472e642eb12ece2f1b2f382f852fa22fef300c3059307630c330e0312d314a319731b432623310331e33b433c2340f341c3469347634c334d0351d352a3577358435d135de362b36383685369236df36ec373937b03866387438c138ce38dc38ea393739833990399e39eb3a373a443a523a9f3aac3af93b063b533b9f3bac3c623c703d243dd83de63e333e403e8d3e9a3ee73f333f403f8d3f9a3fa83ff54041404e405c40a940b6416c4222423042e442f243a6445a4466446c44ba44e245364543458645904674468c469a46a946b846c8476c481448bc48c848d4495a4a1a4aa04ab24b564c174c204ca64cc24d734e144e204e2c4eb24f724ff8500a50ca51505162520752755334533b53c153d2547654d7041011ef55aaffffff11000100020003000401a09bc7a98700000000040101696c140000000100ffffffff0000000000000000632a155700001c88059857c000001c88059857c4c027bf420005693401696c110169645cc400000003000000000000002e00050211b8e48dfb4a35791a44000600070a8a04a893f90761c3528acbec05c0bee677451e015d59296bab513f9f6f4e4d863c2f5c261665a2ad4980524b6f25e0dbd8ca0ed5760fb69e488eea56c238c612b296016e016e000b000c1489cf4c97e523170830372d895f725312c3597e33da831f3dc144623deeaf2cd93900084a33f6fdce432e7267fe17b5d5dc0b1237d92b8cf2bdca45d925c69a4395a8088298df29a34f919fb8d00d344b3421c92679ec1ebb444d7093bebb5dd13075019854fd93c0011b011c011d011e009800001c880589158401696c13a844436ae5d8bda80868a05a061a2d86323220e08249293d915805d944b9243796be33bda64aa44dac4602e96f76c7e25fb44815cecfb8e5616f6c961a58bc66022581fa70fb1404054a5c0fd387d8f1cbf324c00800080008001d43e03a0a4251abc8d211954fc400080201200009000a0015be000003bcb355ab466ad00015bfffffffbcbd0efda563d0345ba893f90761c3528acbec05c0bee677451e015d59296bab513f9f6f4e4d863c2f4138d30f991d6f321fc0e454bec4a5f58334b6b969e558f62914dcf893935e6e016e00149023afe2ffffff1100ffffffff000000000000000001696c1300000001632a155300001c880589158401696c0e600012001300140015245b9023afe2ffffff1100ffffffff000000000000000001696c1400000001632a155700001c88059857c401696c1160000d000e000f0010011100000000000000005000113213d99912bb6ff65e836aaf5a69c806568e6c878ca74cbd26a45d1c7194880970ce2491abc6b29c57aca78df614c22edc2b8ddee21ca0d088f08cfdd00840de739c016d00138207e9c3ec78e5f99270006d008b22330000000000000000ffffffffffffffff81fa70fb1e397e649828008b001634552e3e38b935f281104655b2e76cefadaef2743a77b54fc6fd9334832231e372754d0c9da37e09da7443dd1bdd0a401442b0811c2709121ff6707ef493e4f84441001b0011cc26aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaac232cfdca101f0237e012000b600b700b8006bb0400000000000000000b4b60a00000e4402c48ac1ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc028480101e4950317a530e54fdac9112a6a9a87b6d9055b3a8d30b1a8802afc290f0b3912000132132246153229dca29b9d47eeed46efd482b42da79f972d0e3f48cac3ac56f682b571d0050fa7abcd7a3148f58e74e972a41e3be83fa3cb22052335ea771530c651016d00138207e9c3ec50101529700026008b22330000000000000000ffffffffffffffff81fa70fb1404054a5828008b00162455cc26aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaac232cfdc9bfa7a4b7e001700b6001800b828480101de5adf45c03a745fc9d3a418d9e2ba096db9c1aaa77bc0898b6d9ebb611d2b400005284801015ca4e8215b6668e8c2441ba5063d91c30e88a8c3c76bfddd425e666bf912e20f000222bf0001160c6a16000569346000039100af3a68880000e43c24e296200b4b22e4796fc4ec243fb2fddf46ce115effefd5bb9af7df7ac5ef7c9703e7bcb929c3da260e902c842df1bb88fb0462fbc104fb2acec96c7ae9f60a96baede1e021f8b8be0019001a2213c3c0000722015e74d12000bb001b32013e067cf0e3d7b078183fa6b9671098f1c81ffa79b68c2f0678fa3f09bd1d93f009a3ab11c27e505bf034ce0d4d41419cb50e6978c3d3a6a66be764f77294f60d0010000b20004e004f2211480000e4402bce9a2400bd001c22112000039100af3a689000bf001d2211480000e4402bce9a2400c1001e221162000039100af3a68900c3001f2211480000e4402bce9a2400c5002022112000039100af3a689000c700212211480000e4402bce9a2400c9002222110000039100af3a689000cb00232212ca00001c880579d34400cd0024221160000039100af3a68900cf002500a9400000e4402bce9a200000722015e74d1005a5b049220b53adcf6812cff79879b761c48ebd1249b7965eea78bf40e923838f7b634bd879a11242c9f755ae58d23e8eff9bb911afac437a66b91a05d1a37af7beece223130103f4e1f628080a94b80027006f008b231301022bca0b9c7ddaec5800280029008b331369f92c49cbcfca31f10e28d2a2b10b61566dc1ac6f35ee12b00d272e494a36219ef551faa999074dabb8548dd0accb9fab057353fdf907dd3329ac1b1e1c63ed0028001001016184008d5abf927800350036008b22130100ca460b0f231b59e8002a00732213010057e3ff3e92136a480074002b221301003d89e9e672e04668002c0077221100e0b017dc8a8c86880078002d221100e0a83ec160293328002e007b220f00c1453b688e1108007c002f220f00c02225548539e80030007f220f00c0221de12d664800800031220f4030085e7766c48a00820032220f00c02170f2223da800330085219dbceaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa818042d7630f048056c21a13239611fe81e8ba0d1bc58d679037f5f02e88740ba77a12ca6a695d8000039100b122b0700342277cff55555555555555555555555555555555555555555555555555555555555555554087ac12d66400000000000007220162456118042d7630f0495d000870088231301006843f2854366991800370038008b22130100f9400e081758f968008c003928480101f87f25a430cfa8abcfc1cdcd7578e635347b441e6a749147fe2f017f1241aca3002228480101b9119ab5deebe4611bcbeedc50a2c0180da4b6ba1c63dee3f33d4561ba314d14001922130100dfb4ea849ad33108003a008f22130100a921815012db8a48003b003c221301009271bf96b8ea13a80092003d221100f6afc1b959f176a8004800a922130100926199b55740cb480094003e2213010092619613c44950a8003f0097221301009261956a594d34a8004000992213010092607248aa6d6b88009a0041221301009260717aa39015e8009c004222130100926070d69fff43880043009f21a1bcd999999999999999999999999999999999999999999999999999999999999820124c0e1a8f1fa05941fae2917b72c2c2c864d59d00e747ad401b39c09c3c5091c004285a8a5330cc000039100b122b050044227bcff3333333333333333333333333333333333333333333333333333333333333333413a0c19daa0000000000000072201624560e0124c0e1a8f1fa0596d000a1004522556c05abc35f2d28c653f4265d7dcb8fc92bed13e967a0e185f076ece6d1737124680ec79228cc47939e7c7900a3004622058f632900a500472175a1f426c656f426000100005d7dcb8fc92bed13e967a0e185f076ece6d1737124680ec79228cc47939e7c7980211b20313a0e2b76056cc740e7774000a7221100f6a2a9ced4e78328004900ab221100ea5909416d750088004a00ad221100ea59006153ba044800ae004b220f00c03929383c0e08004c00b1219bbd62f8f7bea30f8ab5e9f16c3fb8642b118f56ed1bdc49600dbe5220c8b1af9e040c474f805753fba0a76497c7e3c7dca1a1f5112a96997997aebd1b2563e208e18645a48680000e4402c48ac1c0004d236fcff34517c7bdf5187c55af4f8b61fdc321588c7ab768dee24b006df29106458d7cf21881f4800000000000007220162456110311d3e017f000b300b400b5220120005000d6220120005a00ec220120005100d8220120005200da220120005300dc220120005400de220120005500e0220120005600e2220120005700e4220120005800e6220120005900e8284801016399760a68a2d391706536a6e23cc74949ce19f23b65802a6ce64b0e9e7a22920001220120005b005c220120005d00f02201200065010422012000f1005e220120005f00f422012000f50060220120006100f8220120006200fa220120006300fc22012000fd006428480101c370f43ccdc364d927d6b176b729ff73d93b6f9d3827efcf5e4a21259335fe400002220120006601062201200067010822012001090068220120010b0069220120006a010e220120010f006b220120006c0112284801019f962415fe4831d51e0afa498a47e15d8e9c23b4302b56eab7ad53cc2f2e2dee000423130103f4e1f63c72fcc938006e006f008b231301022bca0bb0e8cd20d800700071008b28480101467803045589340a8a4411ca40265b31e9acee0a296af9be2dfb9c712d0a5b9f016b3313e2447bd6595a4eac3b68a15d8998fcc00c4637f01d483c5ae64d571dbb6fd3320941a02b12a6f9e558722efbc94d94078633e9f4b9aa887d7e998a4202cbad0f002800100101618400a1c5b1c6f80089008a008b22130100ca460b0f231b59e8007200732213010057e3ff3e92136a480074007528480101da3328921f494abfa69b53e7493187c5f02dac635d6e4ab0e1dd1c38e078cd6d002628480101cc2d5190e7bfce02eecbe148008e84228f8fc904dc3a737c983dfd9da67437d7001a221301003d89e9e672e0466800760077221100e0b017dc8a8c86880078007928480101546a846cbf7bbba6842c30bba65f5d45476eff71308e8fb3ac20db58f6360576001b28480101a2bdfb247a2f156649f1dd7b9fd86f7386538a2877de3fc182eb5aea50fecd090018221100e0a83ec160293328007a007b220f00c1453b688e1108007c007d28480101e0f82f74fd9f84f9615796d34368b051ab48b7e15ad3a8713aac1535957eb656001528480101c49fef14c1eaf3003364ad665766f7e1aa6acc6b8e28e4924280e949bc5a79e80014220f00c02225548539e8007e007f220f00c0221de12d66480080008128480101eb38ef90c590bedb3ce31140d2d4176d43db6b7aab35df685afc4ccf2a383209000b284801019bec9db5132d5dedebf50496978e7145b363e1bd60739352ab08bd7a0af96c020010220f4030085e7766c48a0082008328480101a248b81f22333cc28f6b6744e4298aefcd9b6f2dc5d7c99e1da1b28c37f3aa0c0007220f00c02170f2223da800840085219dbceaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa818042d7630f0495b54d7818171871c601be3f50d7fa60902e4b536125b215a1ebd3298fc6ca852000039100b30af870086284801010143b3d2dd671b2559543155e003f847022e510b3a57afabbca05d4069c327ef000d2277cff55555555555555555555555555555555555555555555555555555555555555554087ac12d6640000000000000722016615f118042d7630f0495d0008700882848010164a43970f2007a1da6d6fc81773cc095d1cc270e81359e471f3b03469abeb7b5000c214900000027cbb9d1062954439a83a91f27835fb9d2e3e798910356650c3c493c94623464684000b628480101e137d8313020d900a920044f1d8543451924bc060cc6a2113813bd8a565d6be6002322130100f9400e1c824b2de8008c008d28480101a5a7d24057d8643b2527709d986cda3846adcb3eddc32d28ec21f69e17dbaaef000128480101bc54a2d4e4e6b4e58d084c3d5e103ed4546f4c86c09514107ae8e55476867d1a002322130100dfb4ea9905c56588008e008f22130100a92181647dcdbec800900091284801019a20d37c3a97abc5aea0a19be6c7f5be2fd007db7238ac35d99e74731abc4bdf0024221301009271bfab23dc482800920093221100f6afc1b959f176a800a800a928480101af2cafb67177843eda40c057ea91a41cc2d30c884dc41fc4fec1ea49541c6fbc001522130100926199c9c232ffc80094009528480101021ea9989b7f46eaf86ec202db2a1071491f8bf75a4055ef0826d2645cf1c8ba001422130100926196282f3b852800960097221301009261957ec43f69280098009928480101e4401b61eeda580799e82672f13b99895dfd6c90316dbfc24cca26830f4f240e0013221301009260725d155fa008009a009b28480101ef1aa8b2068cf6a8eadef8197235a5d5976865a32a3ad1fe80db069ddb8cc2fe001128480101897e0d5f6948d0ebfd6059f7ce4a9d302f003387f550bc111eaff29a00fd3f6a0011221301009260718f0e824a68009c009d28480101a6c30a7e81a2e235344d60e25deb529ea81ecaaf18ba7ad4d1094ad4e688dc3b001022130100926070eb0af17808009e009f21a1bcd999999999999999999999999999999999999999999999999999999999999820124c0e1d1c7de6e8e9e47b3597f7d8d286d471569e0d9c491d328f412869919033ccba6355cf71b6000039100b30af8500a02848010150725eee52e86432f846698a08ac153a67bc9ad9c160130af907c3bef05f29480007227bcff3333333333333333333333333333333333333333333333333333333333333333413a0c19daa00000000000000722016615f0e0124c0e1d1c7de6e96d000a100a2284801016217f872c99fafcb870f2c11a362f59339be95095f70d00b9cff2f6dcd69d3dd000e22556c05abc35f2d28c653f4265d7dcb8fc92bed13e967a0e185f076ece6d1737124680ec79228cc47939e7c7900a300a4284801017beaf3d626ff1c1157c3256086eaf65e4c5cb36f1e06fc4bff5c254d0afe11e1000822058f632900a500a6284801015760bd8f1523c626109fac6ebd27fdd41c13ff9b4ac77b2cd0d0e5db35fe115b00192175a1f426c656f426000100005d7dcb8fc92bed13e967a0e185f076ece6d1737124680ec79228cc47939e7c7980211b20313a0e2b76056d6a98791b4000a7284801013381db8de42ac7bd1c86e3b9260a0a4c3dba0eeedd0948411fe87f8e61cb7a2b000a221100f6a2a9ced4e7832800aa00ab28480101a72253058d44c955a033c71df4919a8dfd898ba5d7611e82899917b98adb74f90016221100ea5909416d75008800ac00ad2848010134678a4d0882ec396f4ff31c1e08e1d15cc43920feef83982ecc53f8b33e3ff90012221100ea59006153ba044800ae00af284801017766b904a739f3f20b86f6a21a58fec2d372a9215b045465563591bc9fcf563c000b28480101e2bc337ece7f3af5171f3265f44c612fc2fcba87f4b4563dc7fdc3285dd6a44d0008220f00c03929383c0e0800b000b1219bbd62f8f7bea30f8ab5e9f16c3fb8642b118f56ed1bdc49600dbe5220c8b1af9e040c474f8043bca7e05a807129637f861fb26fdb0cd8f87a0abd139aba7c2488095826b3e580000e4402cc2be1c000b22848010167cade27e6bad58c3a0788275bb5209fa153b02e410162e9f1eed3225f858b9b0007236fcff34517c7bdf5187c55af4f8b61fdc321588c7ab768dee24b006df29106458d7cf21881f480000000000000722016615f110311d3e017f000b300b400b5284801017269fb9feb45d719ebdbc3b0816b987bab06f43378dc84dc84d55727905482140002004811fd096c000000000000000000000000000000000000000000000000000000000000000028480101986c49971b96062e1fba4410e27249c8d73b0a9380f7ffd44640167e68b215e80003284801018c3d1f497f640f7231832c2db4c305c7d09956604969ff78626ebcabdfe3c204001022bf0001160c6a16000569346000039100b122b0880000e43c24e296200b4b22e4796fc4ec243fb2fddf46ce115effefd5bb9af7df7ac5ef7c9703e7bcb929c3da260e902c842df1bb88fb0462fbc104fb2acec96c7ae9f60a96baede1e021f8b8be00b900ba28480101b20e36a3b36a4cdee601106c642e90718b0a58daf200753dbb3189f956b494b600012213c3c0000722016245612000bb00bc22012000d300d428480101258d602eaa21d621634dcf86692aeae308ff3cf888f3edafc6a5b21848d732f900182211480000e4402c48ac2400bd00be284801014b01ebcf5425735461aa8b83bae89e70fa21e95d2ee85e57b05dad26c1d6d530001622112000039100b122b09000bf00c02848010165b0a85a0fdea0c76a2a98445623ea62427099a6318624794dea416f1bdc6f5c00152211480000e4402c48ac2400c100c228480101cce04453b5ebd066ec571f97e2c381ff3869760c73e49bc875e1c7558fa009830013221162000039100b122b0900c300c428480101943eb6e1a8ab6d59084e5c02d47fb6d1df070a97ea38aac1cd0c2642ccc1fd5a00102211480000e4402c48ac2400c500c6284801017cafaec516263926c8a4b3688a00799a4295f1ec29895c2e425802ca10a4eb8b000e22112000039100b122b09000c700c82848010148863971820997c09f712d4610ce3922359e7080191e30da8193bb06a46ab1b1000d2211480000e4402c48ac2400c900ca284801015ef0bea8e1ca990b2c112458ff12a184ea718b4db8b7f36b9dc9717e4597bf84000b22110000039100b122b09000cb00cc28480101b41cec6db88843c0c575e079a030926c1cf6e1297ceeb70bdd35b545fe91bf66000a2212ca00001c880589158400cd00ce284801019d6113c263e5bde09493cc2ba94af44e2a0e42a4773af83c1c6681c9f97c85e20004221160000039100b122b0900cf00d028480101ece24ee394a769c5547ecda44f1ba72c58c8b0a2c667dd1c43ff1af218c22a47000102110000039100b122b09000d100d200a90000039100af3a68800001c880579d34401696c124882d4eb73da04b3fde61e6dd87123af44926de597ba9e2fd03a48e0e3ded8d2f61e684490b27dd56b96348fa3bfe6ee446beb10de99ae46817468debdefbb38800a90000039100b122b0800001c880589158401696c13a844436ae5d8bda80868a05a061a2d86323220e08249293d915805d944b9243796be33bda64aa44dac4602e96f76c7e25fb44815cecfb8e5616f6c961a58bc66822012000d500d632017c6238b11c984a83dc898966b60817d559089fb10de18af693cbb75f8247664df5ce72d18ed7454d2631a4c030032533ea388a9c2a1e749cbc6bcfed7a9a74e1000f000e2000eb00ec22012000d700d828480101a05331025089c688c8198fd10c0569803d46b4ff7e6d3b31153994ce24718036000e22012000d900da28480101f97df6fed140b9778faa234d338c175662e7d0a7c6139548685afc5fd3acf53d000d22012000db00dc284801016c7cf2d789fe3cf0c94f8193943fcf7bf4378c6a5f714ed2a1c2ddab241c27d7000b22012000dd00de28480101def108425d418746e8e01c567928eb28a5ae688fc98ff8a486bd6df01c3b317e000a22012000df00e0284801010596d5f8a8dd5c371d2578a1201daac95cbe117209820c555ab3589726de7ef6000922012000e100e2284801013a7fdd70f538f3f2af484814f690882d893c7881c245a4c3658b80b886093707000722012000e300e4284801012c3613a6783c9037f33c86754e25644263e194b89e8eaef744af36558ebca1ec000622012000e500e628480101e2fd690fda3693c29700fc8efbb58b494abaa9bda64658f7ce0e6263085cbdb6000522012000e700e828480101cd58033884f82d823d2e0c6681ed0efd059c0968967d26c69977e6ae3b9c823b000202012000e900ea2848010187c4b6012c6d7e54b34a1b9e61c34aabe53b4422831ff6737cbc8b88d742ee6400020073de88c6542aae0000000002d2d8260000048cb4bc960e000091b685f3a55cc6542aae0000000015825616000004c73bb5b14c00009ac03952011900b1bd26c4bf67a7369807507b096d1e5391c271b504ddd7f122d739ef87fc7dfb3d18c67e64400000000000003340000001cffff0b9400000208d9166c798c67d700000000000000023c000000152cdabedc0000016da450b336022012000ed00ee28480101f40b0b01e83fd55e4fd51fa4fc57f29e64495485ba4667ba1b6655b4deae9709000e22012000ef00f02201200103010422012000f100f228480101cb47ab2e5efc77e1c19c247eb406c2dc1ee4048df7f4b51e4a64ecedced71622000c284801016ff2371c8b714cf6ac0521afa7eb180e95910468104751bb7eed178e01da3ec8000a22012000f300f422012000f500f6284801014c7d80c18e7f201a6b3e13d2d18cc8263daa19d50d3cfd9d88511fd4c8883b91000a2848010150163f0bce25531c0ebfa63609767fad5fcb8440ecb4b37ffc5b7729f29d1f52000822012000f700f822012000f900fa284801019cfc1c2354db080cd953f0d89f05599e0e0467c11a22e120984a8ac5bc08011c000622012000fb00fc28480101c5cd95841a0bd8c3a6393f532588de4036d427c93d5ff1a38666fa94f335a4ef000522012000fd00fe2848010154365b0e1df52dedfceb9b9b5f3c9cf5f0ee5b6b0a075712517022c0e54a2e4f000428480101d4b40ef831eaf33420007439d664f4a0a6cf927ece2a1f5df462a26531fc90a2000302012000ff010000b1bd2805339eefdcf7d918fe89c02e0aa38babeea7d1cc563633e5103e5488227518c73e82800000000000002f8000000161f34d7fc000001e12afccbf18c73780800000000000001540000001425244a24000000d8cbcba19200201660101010200afbc46e94ee499ba4c97ea74eb6801fbaeb4ac51384361e573254a7edc525a7aa8c63bf3c400000000000001a20000000bf2cb0b8e0000010606b271aac63be69a00000000000000c40000000caec2108e00000084360cb43500afbc5a38b82c592a9a7d002154fca6a76fb973ad84142a0849cfcecff4c1af586800000000000000000000000000000000000000000000000000000000c6542aae000000000000001000000008fb0b601c0000000f93f9d9d12201200105010628480101559d47d01d635c2c30249e5b69844b8e97cbd6b8c7fd1d946ba6cf1eb166c165000c22012001070108284801013c487ae8d2f65546a569b31f2e265b33a88d1577963feb6340ec94259476a7fc000b2201200109010a28480101f7bcb11eb947ebb7724f49440559f75fa0c3fdc05a2f182afdea5f5d0be2c6070009284801012de4928300fc3835575030950d3fc4f54f30a882a80bc1b782d5dd1ca06d93a60008220120010b010c284801013b99202bec9c46af891dc82f5e85994c4ee88265024386c9ca25b8a28346e8bf0006220120010d010e220120010f0110284801016c95748264f7fc06f07979ae935767052b30bff9c045ed9e0474baf1442c7c9c00052848010175ee3cd2b5731432d0fb57bd0dd877b500de0fb39a0a69d2c798c38f3de3e297000522012001110112020120011301142848010146cce5dfa3dc5a38b9051b1feedc407e30b0f4185bef1e3296a052373d6d23af00020201200115011600b1bd30904ed2d9b54d4ea9acbb08224b09ef86a3d66c9673eefeea88546431f4f90000000000000000000000000000000000000000000000000000000018c6f4d5800000000000001240000000ed787848c000000cc8a8d5af6000b1bccab79c5ee7c0db770d80430646b30e66e923b97536c0044f4e44d02012d4ca00000000000000000000000000000000000000000000000000000000318bfa82000000000000002d0000000176f8442c8000001aca061169400201200117011800b0bc9fea53e5abf14168b6f89d41f88a0564523c98c7780f2f514464f0c59889f4000000000000000000000000000000000000000000000000000000006315e8d1000000000000006500000004a843d35c0000003edeb280960201200119011a00afbc58c37a847ca490abb195a8fd9e9d86c105d30f86c31f9f07b2e3da96c5856800000000000000000000000000000000000000000000000000000000c62be2c600000000000000760000000751e34286000000546377e83500afbc7233f71a01a68966843924cf3d83d76889ae1277d76bba260ea0330a9fb268c6542aae000000000000002a0000000bd07cea7600000027dc58b0bcc6541da6000000000000003400000019a36213b400000032770a530501038020011f00010211015ca6998b4b25f2fa4dbf8843c49a6b5bb8fad7b99d986a3b82f44ba70250bdae00078201270317cca5687c07414843b9aca0040120012101220247a002726d085b71b5444e21e5c99ba6949a843c08d7d1ba3e1c6ae9da5c0899e4d7400610012601330103d0400123003fb000000000400000000000000021f01d05210ee6b280087c07414843b9aca004010150012501db500de0e3f80b4b60a00000e4402c48ac000000e4402c48ac302f04343f99a53f1e3438f8be869b34e2cc728789194d15913fd06bcc9d9f65babaf2338c9d6ffc7123e6d3c3aa3d7bab65ad7c4b9b09b5a839f948063d20361080002b504400000000000000000b4b608b1950aa920124001343e03a0a421dcd6500200201610126013301064606000137020340400128012902037604012a012b0297bf955555555555555555555555555555555555555555555555555555555555555502aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaad000000722016615f0c1014401460397beb33333333333333333333333333333333333333333333333333333333333333029999999999999999999999999999999999999999999999999999999999999999cf80000722016615f0040012c012d012e0397be8517c7bdf5187c55af4f8b61fdc321588c7ab768dee24b006df29106458d7cf029a28be3defa8c3e2ad7a7c5b0fee190ac463d5bb46f71258036f9488322c6be7cf80000722016615f00400139013a013b01035040012f0103404001330082728e05a2ad38072202098b99990e8c1766429f4a295704e56c879557ecf9002263a80f1f950f6b43fac49fc4592b525847b40fcd8348797a40972943a7f59cb79303af7333333333333333333333333333333333333333333333333333333333333333300001c88059857c1a0fd7148bdb9616164326ace8073a3d6a00d9ce04e1e2848e002142d4529986600001c8805891582632a155700014080145013001310082728e05a2ad38072202098b99990e8c1766429f4a295704e56c879557ecf9002263f01f4e51a95a5c9ad348fb0e1be2d05ef0a0ca145d99be414bbc8f5620590c0e02052030240132014900a04453b004c4b4000000000000000000b50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003af7333333333333333333333333333333333333333333333333333333333333333300001c88059857c2bcd9006df8d36479a4ea88e38621529793fb1e48fb529b5eab68aa10f6ce37a200001c88059857c1632a155700014080134013501360101a00137008272f01f4e51a95a5c9ad348fb0e1be2d05ef0a0ca145d99be414bbc8f5620590c0ea80f1f950f6b43fac49fc4592b525847b40fcd8348797a40972943a7f59cb793020f040928d5e46918110138014900ab69fe00000000000000000000000000000000000000000000000000000000000000013fccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccd28d5e469000000039100b30af80c6542aae40009e42af6c10b9e80000000000000000640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001035040013c01035040013f00827213f3ab5fcb91bfb420b3296582f796c77cfcf77a18ed28729684a7bdd550fa929e91d1624e79eb5cae6064a35d7dbafcc5bca0c93b0ba39155b4747706e100fe03af734517c7bdf5187c55af4f8b61fdc321588c7ab768dee24b006df29106458d7cf00001c88059857c1aea7f7414ec92f8fc78fb94343ea22552d32f32f5d7a364ac7c411c30c8b490d00001c8805891583632a155700014080145013d013e00827213f3ab5fcb91bfb420b3296582f796c77cfcf77a18ed28729684a7bdd550fa92fd6f12eb7a597d678a70eda6092ace6998cd57e0a18aae330808c0bc29154c1202052030340142014303af734517c7bdf5187c55af4f8b61fdc321588c7ab768dee24b006df29106458d7cf00001c88059857c395cb0fe13a523a939fb18e03da92616b909c77096b78a1580bf4585cd14a7bb400001c88059857c1632a15570001408014501400141008272fd6f12eb7a597d678a70eda6092ace6998cd57e0a18aae330808c0bc29154c129e91d1624e79eb5cae6064a35d7dbafcc5bca0c93b0ba39155b4747706e100fe02053030340142014300a042665004c4b400000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000069600000009600000004000600000000000519ae84f17b8f8b22026a975ff55f1ab19fde4a768744d2178dfa63bb533e107a409026bc03af7555555555555555555555555555555555555555555555555555555555555555500001c88059857c302b610d0991cb08ff40f45d068de2c6b3c81bfaf817443a05d3bd09653534aec00001c8805891583632a15570001408014501460147000120008272e9d1638ebe1916901165a1767910893b1e35c6414b42afc9427f9ed88288573c3104b2cd5d91d77731603fc6bfb7e3a9d9e545e3ce3345dfa07698bb9676912a02053030240148014900a041297004c4b40000000000000000002e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005bc00000000000000000000000012d452da449e50b8cf7dd27861f146122afe1b546bb8b70fc8216f0c614139f8e0451e13e98")
	
	result = deserialize_boc(data)
	print(result)
	
#end define



###
### Start of the program
###

if __name__ == "__main__":
	tests()
#end if



